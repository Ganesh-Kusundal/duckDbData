{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://tradingsystem.com/schemas/rule",
  "title": "Trading Rule Schema",
  "description": "JSON Schema for trading rules in the unified scanner system",
  "type": "object",

  "required": ["rule_id", "name", "rule_type", "conditions", "actions"],
  "properties": {

    "rule_id": {
      "type": "string",
      "description": "Unique identifier for the rule (kebab-case recommended)",
      "pattern": "^[a-z0-9]+([-.][a-z0-9]+)*$",
      "minLength": 3,
      "maxLength": 100,
      "examples": ["breakout-volume-1.5x", "crp-high-confidence", "rsi-divergence-bullish"]
    },

    "name": {
      "type": "string",
      "description": "Human-readable name for the rule",
      "minLength": 5,
      "maxLength": 200,
      "examples": ["Volume Breakout Scanner", "High Confidence CRP Signals"]
    },

    "description": {
      "type": "string",
      "description": "Detailed description of what the rule does",
      "minLength": 10,
      "maxLength": 1000
    },

    "rule_type": {
      "type": "string",
      "description": "Type of trading rule/scanner",
      "enum": ["breakout", "crp", "technical", "volume", "momentum", "reversal", "trend", "custom"],
      "examples": ["breakout", "crp", "technical"]
    },

    "enabled": {
      "type": "boolean",
      "description": "Whether the rule is active and should be executed",
      "default": true
    },

    "priority": {
      "type": "integer",
      "description": "Execution priority (higher numbers execute first)",
      "minimum": 1,
      "maximum": 100,
      "default": 50
    },

    "conditions": {
      "type": "object",
      "description": "Conditions that must be met for the rule to trigger",
      "properties": {

        "time_window": {
          "type": "object",
          "description": "Time window for rule execution",
          "properties": {
            "start": {
              "type": "string",
              "description": "Start time (HH:MM format)",
              "pattern": "^([01]?[0-9]|2[0-3]):[0-5][0-9]$"
            },
            "end": {
              "type": "string",
              "description": "End time (HH:MM format)",
              "pattern": "^([01]?[0-9]|2[0-3]):[0-5][0-9]$"
            }
          },
          "required": ["start", "end"]
        },

        "symbols": {
          "type": "array",
          "description": "List of symbols to apply rule to (empty = all symbols)",
          "items": {
            "type": "string",
            "pattern": "^[A-Z]+$"
          },
          "uniqueItems": true
        },

        "market_conditions": {
          "type": "object",
          "description": "General market conditions",
          "properties": {
            "min_volume": {
              "type": "number",
              "description": "Minimum volume for consideration",
              "minimum": 0
            },
            "max_volume": {
              "type": "number",
              "description": "Maximum volume for consideration",
              "minimum": 0
            },
            "min_price": {
              "type": "number",
              "description": "Minimum stock price",
              "minimum": 0
            },
            "max_price": {
              "type": "number",
              "description": "Maximum stock price",
              "minimum": 0
            }
          }
        },

        "breakout_conditions": {
          "type": "object",
          "description": "Conditions specific to breakout rules",
          "properties": {
            "min_price_move_pct": {
              "type": "number",
              "description": "Minimum price movement percentage",
              "minimum": 0,
              "maximum": 100
            },
            "max_price_move_pct": {
              "type": "number",
              "description": "Maximum price movement percentage",
              "minimum": 0,
              "maximum": 100
            },
            "min_volume_multiplier": {
              "type": "number",
              "description": "Minimum volume multiplier",
              "minimum": 0
            },
            "volume_comparison_period": {
              "type": "integer",
              "description": "Number of periods to compare volume against",
              "minimum": 1,
              "default": 10
            },
            "breakout_direction": {
              "type": "string",
              "enum": ["up", "down", "both"],
              "default": "up"
            }
          }
        },

        "crp_conditions": {
          "type": "object",
          "description": "Conditions specific to CRP (Close-Range-Pattern) rules",
          "properties": {
            "close_threshold_pct": {
              "type": "number",
              "description": "Maximum % difference for close near high/low",
              "minimum": 0,
              "maximum": 50
            },
            "range_threshold_pct": {
              "type": "number",
              "description": "Maximum % for narrow trading range",
              "minimum": 0,
              "maximum": 100
            },
            "consolidation_period": {
              "type": "integer",
              "description": "Number of days for consolidation check",
              "minimum": 1,
              "default": 5
            },
            "close_position_preference": {
              "type": "string",
              "enum": ["near_high", "near_low", "mid_range", "any"],
              "default": "any"
            }
          }
        },

        "technical_conditions": {
          "type": "object",
          "description": "Technical indicator conditions",
          "properties": {
            "rsi": {
              "type": "object",
              "properties": {
                "period": {"type": "integer", "minimum": 2, "default": 14},
                "overbought": {"type": "number", "minimum": 50, "maximum": 100, "default": 70},
                "oversold": {"type": "number", "minimum": 0, "maximum": 50, "default": 30},
                "condition": {"type": "string", "enum": ["overbought", "oversold", "neutral"]}
              }
            },
            "macd": {
              "type": "object",
              "properties": {
                "fast_period": {"type": "integer", "minimum": 2, "default": 12},
                "slow_period": {"type": "integer", "minimum": 2, "default": 26},
                "signal_period": {"type": "integer", "minimum": 2, "default": 9},
                "condition": {"type": "string", "enum": ["bullish", "bearish", "neutral"]}
              }
            },
            "moving_averages": {
              "type": "object",
              "properties": {
                "sma_20": {"type": "boolean", "default": false},
                "sma_50": {"type": "boolean", "default": false},
                "ema_12": {"type": "boolean", "default": false},
                "ema_26": {"type": "boolean", "default": false}
              }
            },
            "bollinger_bands": {
              "type": "object",
              "properties": {
                "period": {"type": "integer", "minimum": 2, "default": 20},
                "deviations": {"type": "number", "minimum": 0.1, "default": 2.0},
                "condition": {"type": "string", "enum": ["upper_breakout", "lower_breakout", "squeeze", "expansion"]}
              }
            }
          }
        },

        "volume_conditions": {
          "type": "object",
          "description": "Volume-based conditions",
          "properties": {
            "min_volume": {"type": "number", "minimum": 0},
            "max_volume": {"type": "number", "minimum": 0},
            "volume_trend": {"type": "string", "enum": ["increasing", "decreasing", "stable"]},
            "relative_volume": {"type": "number", "minimum": 0},
            "accumulation_distribution": {"type": "boolean", "default": false}
          }
        },

        "momentum_conditions": {
          "type": "object",
          "description": "Momentum and trend conditions",
          "properties": {
            "trend_direction": {"type": "string", "enum": ["uptrend", "downtrend", "sideways"]},
            "momentum_period": {"type": "integer", "minimum": 1, "default": 14},
            "momentum_threshold": {"type": "number", "minimum": 0, "default": 0.01},
            "rate_of_change": {"type": "number", "minimum": 0}
          }
        }
      }
    },

    "actions": {
      "type": "object",
      "description": "Actions to take when conditions are met",
      "required": ["signal_type"],
      "properties": {

        "signal_type": {
          "type": "string",
          "description": "Type of trading signal to generate",
          "enum": ["BUY", "SELL", "HOLD", "ALERT"],
          "examples": ["BUY", "SELL"]
        },

        "confidence_calculation": {
          "type": "string",
          "description": "Method to calculate signal confidence",
          "enum": ["weighted_average", "max_condition", "min_condition", "custom"],
          "default": "weighted_average"
        },

        "risk_management": {
          "type": "object",
          "description": "Risk management parameters",
          "properties": {
            "stop_loss_pct": {
              "type": "number",
              "description": "Stop loss percentage",
              "minimum": 0,
              "maximum": 100
            },
            "take_profit_pct": {
              "type": "number",
              "description": "Take profit percentage",
              "minimum": 0,
              "maximum": 100
            },
            "max_position_size_pct": {
              "type": "number",
              "description": "Maximum position size as percentage",
              "minimum": 0,
              "maximum": 100
            },
            "max_drawdown_pct": {
              "type": "number",
              "description": "Maximum allowed drawdown",
              "minimum": 0,
              "maximum": 100
            }
          }
        },

        "alert_settings": {
          "type": "object",
          "description": "Alert and notification settings",
          "properties": {
            "email_notification": {"type": "boolean", "default": false},
            "sms_notification": {"type": "boolean", "default": false},
            "webhook_url": {"type": "string", "format": "uri"},
            "alert_threshold": {"type": "number", "minimum": 0, "maximum": 1, "default": 0.7}
          }
        },

        "execution_settings": {
          "type": "object",
          "description": "Trade execution settings",
          "properties": {
            "auto_execute": {"type": "boolean", "default": false},
            "max_slippage_pct": {"type": "number", "minimum": 0, "maximum": 100},
            "execution_delay_seconds": {"type": "integer", "minimum": 0, "default": 0}
          }
        }
      }
    },

    "metadata": {
      "type": "object",
      "description": "Additional metadata for the rule",
      "properties": {
        "author": {
          "type": "string",
          "description": "Rule author/creator",
          "examples": ["quant_team", "trading_strategy_committee"]
        },
        "created_at": {
          "type": "string",
          "description": "Rule creation timestamp",
          "format": "date-time"
        },
        "updated_at": {
          "type": "string",
          "description": "Rule last update timestamp",
          "format": "date-time"
        },
        "version": {
          "type": "string",
          "description": "Rule version",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "examples": ["1.0.0", "2.1.3"]
        },
        "tags": {
          "type": "array",
          "description": "Tags for categorization and filtering",
          "items": {"type": "string"},
          "uniqueItems": true,
          "examples": [["breakout", "volume", "momentum"], ["crp", "high-confidence"]]
        },
        "performance_expectations": {
          "type": "object",
          "description": "Expected performance metrics",
          "properties": {
            "expected_win_rate": {"type": "number", "minimum": 0, "maximum": 1},
            "expected_profit_factor": {"type": "number", "minimum": 0},
            "expected_max_drawdown": {"type": "number", "minimum": 0, "maximum": 1},
            "backtest_period_months": {"type": "integer", "minimum": 1}
          }
        },
        "risk_assessment": {
          "type": "object",
          "description": "Risk assessment information",
          "properties": {
            "risk_level": {"type": "string", "enum": ["low", "medium", "high"]},
            "market_conditions": {"type": "string", "enum": ["bull", "bear", "sideways", "volatile", "all"]},
            "liquidity_requirements": {"type": "string", "enum": ["low", "medium", "high"]},
            "holding_period": {"type": "string", "examples": ["intraday", "swing", "position"]}
          }
        }
      }
    }
  },

  "additionalProperties": false
}
